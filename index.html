<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>选课辅助系统 - 精准排除版</title>
    <style>
        :root { 
            --sidebar-bg: #1e293b; 
            --main-bg: #f1f5f9; 
            --primary: #3b82f6; 
            --border: #e2e8f0; 
            --accent: #f43f5e; 
            --highlight: #f59e0b; 
            --banner-bg: #fefce8;
            --banner-text: #a16207;
            --excluded-bg: #e2e8f0;
            --excluded-stripe: #cbd5e1;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --danger-light: #ffe4e6;
            --danger: #e11d48;
        }
        
        body, html { height: 100vh; margin: 0; padding: 0; font-family: "SF Pro Display", "PingFang SC", sans-serif; }
        body { display: flex; background: var(--main-bg); color: #1e293b; overflow: hidden; }
        
        /* 侧边栏 */
        .sidebar { width: 260px; background: var(--sidebar-bg); color: white; display: flex; flex-direction: column; flex-shrink: 0; z-index: 10; transition: all 0.3s; }
        .sidebar-header { padding: 25px 20px; border-bottom: 1px solid #334155; font-weight: 700; font-size: 1.2em; }
        .db-list { flex: 1; overflow-y: auto; padding: 15px; }
        .db-list::-webkit-scrollbar { width: 4px; height: 4px; }
        .db-list::-webkit-scrollbar-thumb { background: #475569; border-radius: 2px; }
        
        .db-item { padding: 12px 18px; margin-bottom: 8px; border-radius: 12px; cursor: pointer; background: #334155; font-size: 14px; transition: 0.3s; white-space: nowrap; }
        .db-item.active { background: var(--primary); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }
        .sidebar-footer { padding: 15px; border-top: 1px solid #334155; background: rgba(0,0,0,0.2); font-size: 11px; color: #94a3b8; line-height: 1.6; }

        /* 主区域 */
        .content { flex: 1; display: flex; flex-direction: column; padding: 15px 20px; min-width: 0; height: 100vh; box-sizing: border-box; overflow-y: auto; }
        .banner { background: var(--banner-bg); color: var(--banner-text); padding: 12px 18px; border-radius: 12px; margin-bottom: 15px; font-size: 13px; line-height: 1.5; border: 1px solid #fef08a; flex-shrink: 0; }
        
        .header-tools { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; flex-shrink: 0; }
        .locate-input { width: 100%; padding: 12px 18px; border: 2px solid white; border-radius: 12px; font-size: 14px; outline: none; transition: 0.3s; box-shadow: var(--card-shadow); box-sizing: border-box; }
        .locate-input.searching { border-color: var(--highlight); box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.1); }

        .filter-container { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
        .tag-chip { padding: 6px 15px; background: white; border-radius: 20px; cursor: pointer; font-size: 12px; color: #64748b; transition: 0.3s; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .tag-chip.active { background: var(--primary); color: white; }

        /* ========================
           新增：矩阵排除控制面板
           ======================== */
        .exclusion-panel {
            background: rgba(255, 255, 255, 0.6);
            padding: 12px;
            border-radius: 16px;
            border: 1px dashed var(--border);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .exclusion-label { font-size: 11px; font-weight: 700; color: #64748b; margin-bottom: 4px; display: flex; align-items: center; justify-content: space-between; }
        
        /* 矩阵网格布局 */
        .matrix-container {
            display: grid;
            grid-template-columns: 40px repeat(5, 1fr); /* 左侧标签 + 5天 */
            gap: 6px;
            width: 100%;
        }

        /* 矩阵单元格通用样式 */
        .mx-cell {
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            border: 1px solid #e2e8f0;
            color: #64748b;
            user-select: none;
        }
        
        /* 表头样式 (周一..周五) */
        .mx-head-col {
            font-weight: 700;
            background: transparent;
            border: none;
            font-size: 12px;
        }
        .mx-head-col:hover { color: var(--danger); background: #fff0f2; }

        /* 行头样式 (上午/下午) */
        .mx-head-row {
            font-weight: 700;
            background: transparent;
            border: none;
            font-size: 11px;
            justify-content: flex-start;
        }
        .mx-head-row:hover { color: var(--danger); }

        /* 激活状态 (被排除) */
        .mx-cell.excluded {
            background: var(--danger-light);
            color: var(--danger);
            border-color: #fda4af;
            text-decoration: line-through;
            font-weight: bold;
        }
        
        /* 鼠标悬停 */
        .mx-cell:not(.mx-head-col):not(.mx-head-row):hover {
            border-color: var(--primary);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* 课表网格 */
        .grid-wrapper { flex: 1; min-height: 0; background: white; border-radius: 15px; padding: 12px; box-shadow: var(--card-shadow); display: flex; flex-direction: column; overflow: hidden; }
        .grid { 
            display: grid; 
            flex: 1; 
            width: 100%; 
            height: 100%; 
            grid-template-columns: 50px repeat(5, 1fr); 
            grid-template-rows: 35px repeat(6, 1fr); 
            gap: 4px; 
            overflow: auto; 
        }
        
        .cell { background: #f8fafc; border-radius: 6px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; font-size: 11px; transition: all 0.2s; border: 1px solid #f1f5f9; text-align: center; overflow: hidden; word-break: break-all; position: relative; }
        .cell.head { background: none; font-weight: 700; color: #94a3b8; cursor: default; border: none; }
        
        .cell.active-slot { border: 2px solid var(--primary) !important; z-index: 5; transform: scale(1.02); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .cell.search-match { border: 2px solid var(--highlight) !important; font-weight: 800; color: #c2410c !important; }

        /* 被排除的格子视觉效果 */
        .cell.excluded-slot {
            background-color: var(--excluded-bg) !important;
            /* 斜纹背景 */
            background-image: repeating-linear-gradient(
                45deg,
                var(--excluded-bg),
                var(--excluded-bg) 10px,
                var(--excluded-stripe) 10px,
                var(--excluded-stripe) 12px
            ) !important;
            pointer-events: none; /* 禁止点击 */
            opacity: 0.6;
            color: transparent !important; /* 隐藏内部文字 */
            border-color: transparent !important;
        }

        /* 右侧面板 */
        .side-panel { width: 320px; background: white; border-left: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; z-index: 20; }
        .panel-header { padding: 20px; border-bottom: 1px solid var(--border); }
        .course-list { flex: 1; overflow-y: auto; padding: 15px; }
        .course-card { background: #fff; border: 1px solid var(--border); border-radius: 12px; margin-bottom: 12px; overflow: hidden; }
        .card-head { padding: 12px; font-weight: 600; font-size: 13px; background: #fcfcfc; }
        .card-body { padding: 12px; font-size: 12px; color: #64748b; border-top: 1px dashed var(--border); }

        @media screen and (max-width: 1024px) {
            body { flex-direction: column; overflow-y: auto; height: auto; }
            .sidebar { width: 100%; height: auto; flex-direction: column; }
            .sidebar-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
            .db-list { display: flex; flex-direction: row; overflow-x: auto; padding: 10px 15px; gap: 10px; border-bottom: 1px solid #334155; }
            .db-item { margin-bottom: 0; flex-shrink: 0; padding: 8px 16px; }
            .sidebar-footer { display: none; }
            .content { height: auto; overflow: visible; padding: 10px; }
            .locate-input { font-size: 16px; }
            .grid-wrapper { height: 65vh; min-height: 400px; }
            .side-panel { width: 100%; height: auto; border-left: none; border-top: 5px solid var(--main-bg); max-height: none; }
            .course-list { max-height: 500px; }
            
            /* 移动端矩阵微调 */
            .mx-cell { font-size: 11px; height: 36px; } /* 稍微加高方便触摸 */
            .mx-head-col { font-size: 11px; }
        }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="sidebar-header">
        选课智能助手
        <span style="font-size: 10px; font-weight: normal; opacity: 0.7; display: none;" id="mobile-hint">左右滑动切换</span>
    </div>
    <div id="menu" class="db-list"></div>
    <div class="sidebar-footer">
        <b>💡 免责声明</b><br>
        本工具仅供排课参考，选中课程后请及时确认。<br><br>
        <b>🚫 排除用法</b><br>
        点击矩阵中的格子，变红即为屏蔽该时段，屏蔽后不计入搜索和热力图。
    </div>
</div>

<div class="content">
    <div id="banner" class="banner"></div>
    
    <div class="header-tools">
        <input type="text" id="locateSearch" class="locate-input" placeholder="🔍 输入课程、教师名实时筛选..." oninput="handleSearch()">
        
        <div class="exclusion-panel">
            <div class="exclusion-label">
                <span>🚫 时段排除 (点击格子屏蔽/恢复)</span>
                <span style="font-size:9px; font-weight:normal; cursor:pointer; color:#3b82f6" onclick="resetExclusion()">↺ 重置所有</span>
            </div>
            
            <div class="matrix-container" id="matrixContainer">
                </div>
        </div>

        <div id="filterChips" class="filter-container"></div>
    </div>
    <div class="grid-wrapper">
        <div id="grid" class="grid"></div>
    </div>
</div>

<div class="side-panel">
    <div class="panel-header">
        <div id="panelTitle" style="font-size: 16px; font-weight: 800;">💡 课程详情</div>
        <div id="slotInfo" style="font-size: 11px; color: #94a3b8; margin-top: 4px;">点击格子查看列表</div>
    </div>
    <div id="courseList" class="course-list"></div>
</div>

<script>
// 课程数据
const DATA_STORE = {
    "通识选修课_2轮": {
        "notice": "🎨 <b>创意提醒：</b>《平面设计》需要自带电脑上课，教室配置了专业手绘板。",
        "courses": [
 {"n":"城市赏析 (人文艺术类-人文类)","t":"谭跃","s":"周二7-8节(每周)(待定)(1-15周)","d":1,"b":7,"e":8,"raw":["城市赏析 (人文艺术类-人文类)","2","1-15","谭跃","周二7-8节(每周)(待定)(1-15周)","35"]},
  {"n":"地域性建筑赏析(1班) (人文艺术类-人文类)","t":"王鑫刚","s":"周二7-8节(每周)(待定)(1-15周)","d":1,"b":7,"e":8,"raw":["地域性建筑赏析(1班) (人文艺术类-人文类)","2","1-15","王鑫刚","周二7-8节(每周)(待定)(1-15周)","33"]},
  {"n":"地域性建筑赏析(2班) (人文艺术类-人文类)","t":"王鑫刚","s":"周二9-10节(每周)(待定)(1-15周)","d":1,"b":9,"e":10,"raw":["地域性建筑赏析(2班) (人文艺术类-人文类)","2","1-15","王鑫刚","周二9-10节(每周)(待定)(1-15周)","58"]},
  {"n":"福建土楼与客家文化 (人文艺术类-人文类)","t":"林建辉","s":"周四7-8节(每周)(待定)(1-15周)","d":3,"b":7,"e":8,"raw":["福建土楼与客家文化 (人文艺术类-人文类)","2","1-15","林建辉","周四7-8节(每周)(待定)(1-15周)","8"]},
  {"n":"鲁迅研究 (人文艺术类-人文类)","t":"林祁","s":"周二9-10节(每周)(待定)(1-15周)","d":1,"b":9,"e":10,"raw":["鲁迅研究 (人文艺术类-人文类)","2","1-15","林祁","周二9-10节(每周)(待定)(1-15周)","65"]},
  {"n":"美国历史与文化(1班) (人文艺术类-人文类)","t":"宋晓东","s":"周四7-8节(每周)(待定)(1-15周)","d":3,"b":7,"e":8,"raw":["美国历史与文化(1班) (人文艺术类-人文类)","2","1-15","宋晓东","周四7-8节(每周)(待定)(1-15周)","33"]},
  {"n":"美国历史与文化(2班) (人文艺术类-人文类)","t":"宋晓东","s":"周四9-10节(每周)(待定)(1-15周)","d":3,"b":9,"e":10,"raw":["美国历史与文化(2班) (人文艺术类-人文类)","2","1-15","宋晓东","周四9-10节(每周)(待定)(1-15周)","59"]},
  {"n":"莎士比亚与西方社会 (人文艺术类-人文类)","t":"夏光武","s":"周四9-10节(每周)(待定)(1-15周)","d":3,"b":9,"e":10,"raw":["莎士比亚与西方社会 (人文艺术类-人文类)","2","1-15","夏光武","周四9-10节(每周)(待定)(1-15周)","73"]},
  {"n":"西方文化史(1班) (人文艺术类-人文类)","t":"孙博","s":"周一9-10节(每周)(待定)(1-15周)","d":0,"b":9,"e":10,"raw":["西方文化史(1班) (人文艺术类-人文类)","2","1-15","孙博","周一9-10节(每周)(待定)(1-15周)","29"]},
  {"n":"西方文化史(2班) (人文艺术类-人文类)","t":"孙博","s":"周二9-10节(每周)(待定)(1-15周)","d":1,"b":9,"e":10,"raw":["西方文化史(2班) (人文艺术类-人文类)","2","1-15","孙博","周二9-10节(每周)(待定)(1-15周)","54"]},
  {"n":"中国古代五行哲学思想研究(1班) (人文艺术类-人文类)","t":"梁忠","s":"周三1-2节(每周)(待定)(1-15周)","d":2,"b":1,"e":2,"raw":["中国古代五行哲学思想研究(1班) (人文艺术类-人文类)","2","1-15","梁忠","周三1-2节(每周)(待定)(1-15周)","15"]},
  {"n":"中国古代五行哲学思想研究(2班) (人文艺术类-人文类)","t":"梁忠","s":"周三7-8节(每周)(待定)(1-15周)","d":2,"b":7,"e":8,"raw":["中国古代五行哲学思想研究(2班) (人文艺术类-人文类)","2","1-15","梁忠","周三7-8节(每周)(待定)(1-15周)","29"]},
  {"n":"中国哲学十六讲(1班) (人文艺术类-人文类)","t":"梁忠","s":"周四7-8节(每周)(待定)(1-15周)","d":3,"b":7,"e":8,"raw":["中国哲学十六讲(1班) (人文艺术类-人文类)","2","1-15","梁忠","周四7-8节(每周)(待定)(1-15周)","33"]},
  {"n":"中国哲学十六讲(2班) (人文艺术类-人文类)","t":"梁忠","s":"周四9-10节(每周)(待定)(1-15周)","d":3,"b":9,"e":10,"raw":["中国哲学十六讲(2班) (人文艺术类-人文类)","2","1-15","梁忠","周四9-10节(每周)(待定)(1-15周)","70"]},
  {"n":"中西文化比较(1班) (人文艺术类-人文类)","t":"付汉生","s":"周二3-4节(每周)(待定)(1-15周)","d":1,"b":3,"e":4,"raw":["中西文化比较(1班) (人文艺术类-人文类)","2","1-15","付汉生","周二3-4节(每周)(待定)(1-15周)","18"]},
  {"n":"中西文化比较(2班) (人文艺术类-人文类)","t":"付汉生","s":"周四7-8节(每周)(待定)(1-15周)","d":3,"b":7,"e":8,"raw":["中西文化比较(2班) (人文艺术类-人文类)","2","1-15","付汉生","周四7-8节(每周)(待定)(1-15周)","54"]},
  {"n":"中西文化比较(3班) (人文艺术类-人文类)","t":"孙博","s":"周三9-10节(每周)(待定)(1-15周)","d":2,"b":9,"e":10,"raw":["中西文化比较(3班) (人文艺术类-人文类)","2","1-15","孙博","周三9-10节(每周)(待定)(1-15周)","33"]},
  {"n":"中西文化比较(4班) (人文艺术类-人文类)","t":"孙博","s":"周四9-10节(每周)(待定)(1-15周)","d":3,"b":9,"e":10,"raw":["中西文化比较(4班) (人文艺术类-人文类)","2","1-15","孙博","周四9-10节(每周)(待定)(1-15周)","65"]},
  {"n":"城市空间与建筑艺术(1班) (人文艺术类-艺术类)","t":"尹巧玉","s":"周二9-10节(每周)(待定)(1-15周)","d":1,"b":9,"e":10,"raw":["城市空间与建筑艺术(1班) (人文艺术类-艺术类)","2","1-15","尹巧玉","周二9-10节(每周)(待定)(1-15周)","38"]},
  {"n":"城市空间与建筑艺术(2班) (人文艺术类-艺术类)","t":"陈宇祯","s":"周四9-10节(每周)(待定)(1-15周)","d":3,"b":9,"e":10,"raw":["城市空间与建筑艺术(2班) (人文艺术类-艺术类)","2","1-15","陈宇祯","周四9-10节(每周)(待定)(1-15周)","52"]},
  {"n":"城市空间与建筑艺术(3班) (人文艺术类-艺术类)","t":"黄雨萌","s":"周二9-10节(每周)(待定)(1-15周)","d":1,"b":9,"e":10,"raw":["城市空间与建筑艺术(3班) (人文艺术类-艺术类)","2","1-15","黄雨萌","周二9-10节(每周)(待定)(1-15周)","48"]},
  {"n":"二胡演奏入门 (人文艺术类-艺术类)","t":"张婷婷","s":"周四9-10节(每周)(学活#二楼圆形多功能厅)(1-15周)","d":3,"b":9,"e":10,"raw":["二胡演奏入门 (人文艺术类-艺术类)","2","1-15","张婷婷","周四9-10节(每周)(学活#二楼圆形多功能厅)(1-15周)","17"]},
  {"n":"歌剧与交响乐(2班) (人文艺术类-艺术类)","t":"陈展宙","s":"周二7-8节(每周)(待定)(1-15周)","d":1,"b":7,"e":8,"raw":["歌剧与交响乐(2班) (人文艺术类-艺术类)","2","1-15","陈展宙","周二7-8节(每周)(待定)(1-15周)","60"]},
  {"n":"歌剧与交响乐(3班) (人文艺术类-艺术类)","t":"李丽莉","s":"周四7-8节(每周)(待定)(1-15周)","d":3,"b":7,"e":8,"raw":["歌剧与交响乐(3班) (人文艺术类-艺术类)","2","1-15","李丽莉","周四7-8节(每周)(待定)(1-15周)","71"]},
  {"n":"家装设计与赏析(3班) (人文艺术类-艺术类)","t":"王廷廷","s":"周五1-2节(每周)(待定)(1-15周)","d":4,"b":1,"e":2,"raw":["家装设计与赏析(3班) (人文艺术类-艺术类)","2","1-15","王廷廷","周五1-2节(每周)(待定)(1-15周)","7"]},
  {"n":"空间设计与生活美学 (人文艺术类-艺术类)","t":"吴一凡","s":"周二7-8节(每周)(待定)(1-15周)","d":1,"b":7,"e":8,"raw":["空间设计与生活美学 (人文艺术类-艺术类)","2","1-15","吴一凡","周二7-8节(每周)(待定)(1-15周)","58"]},
  {"n":"设计思维体验与鉴赏 (人文艺术类-艺术类)","t":"吴国荣","s":"周二7-8节(每周)(待定)(1-15周)","d":1,"b":7,"e":8,"raw":["设计思维体验与鉴赏 (人文艺术类-艺术类)","2","1-15","吴国荣","周二7-8节(每周)(待定)(1-15周)","66"]},
  {"n":"书法(1班) (人文艺术类-艺术类)","t":"王占北","s":"周二7-8节(每周)(待定)(1-15周)","d":1,"b":7,"e":8,"raw":["书法(1班) (人文艺术类-艺术类)","2","1-15","王占北","周二7-8节(每周)(待定)(1-15周)","38"]},
  {"n":"书法(2班) (人文艺术类-艺术类)","t":"王占北","s":"周二9-10节(每周)(待定)(1-15周)","d":1,"b":9,"e":10,"raw":["书法(2班) (人文艺术类-艺术类)","2","1-15","王占北","周二9-10节(每周)(待定)(1-15周)","37"]},
  {"n":"书法(3班) (人文艺术类-艺术类)","t":"陆海翔","s":"周二7-8节(每周)(待定)(1-15周)","d":1,"b":7,"e":8,"raw":["书法(3班) (人文艺术类-艺术类)","2","1-15","陆海翔","周二7-8节(每周)(待定)(1-15周)","17"]},
  {"n":"书法(4班) (人文艺术类-艺术类)","t":"陆海翔","s":"周二9-10节(每周)(待定)(1-15周)","d":1,"b":9,"e":10,"raw":["书法(4班) (人文艺术类-艺术类)","2","1-15","陆海翔","周二9-10节(每周)(待定)(1-15周)","15"]},
  {"n":"书法(5班) (人文艺术类-艺术类)","t":"陆海翔","s":"周四7-8节(每周)(待定)(1-15周)","d":3,"b":7,"e":8,"raw":["书法(5班) (人文艺术类-艺术类)","2","1-15","陆海翔","周四7-8节(每周)(待定)(1-15周)","9"]},
  {"n":"书法(6班) (人文艺术类-艺术类)","t":"陆海翔","s":"周四9-10节(每周)(待定)(1-15周)","d":3,"b":9,"e":10,"raw":["书法(6班) (人文艺术类-艺术类)","2","1-15","陆海翔","周四9-10节(每周)(待定)(1-15周)","33"]},
  {"n":"水彩绘画(1班) (人文艺术类-艺术类)","t":"魏巨川","s":"周四5-8节(每周)(文C#310)(1-7周)","d":3,"b":5,"e":8,"raw":["水彩绘画(1班) (人文艺术类-艺术类)","2","1-15","魏巨川","周四5-8节(每周)(文C#310)(1-7周)","10"]},
  {"n":"水彩绘画(2班) (人文艺术类-艺术类)","t":"魏巨川","s":"周四5-8节(每周)(文C#310)(9-15周)","d":3,"b":5,"e":8,"raw":["水彩绘画(2班) (人文艺术类-艺术类)","2","1-15","魏巨川","周四5-8节(每周)(文C#310)(9-15周)","25"]},
  {"n":"水彩绘画(3班) (人文艺术类-艺术类)","t":"侯思雨","s":"周四5-8节(每周)(文A#101)(1-8周)","d":3,"b":5,"e":8,"raw":["水彩绘画(3班) (人文艺术类-艺术类)","2","1-15","侯思雨","周四5-8节(每周)(文A#101)(1-8周)","2"]},
  {"n":"水彩绘画(4班) (人文艺术类-艺术类)","t":"曾金妹","s":"周四1-4节(每周)(文C#101)(1-8周)","d":3,"b":1,"e":4,"raw":["水彩绘画(4班) (人文艺术类-艺术类)","2","1-15","曾金妹","周四1-4节(每周)(文C#101)(1-8周)","6"]},
  {"n":"水墨画入门(2班) (人文艺术类-艺术类)","t":"陈莉(教师)","s":"周四5-8节(每周)(文C#307)(9-15周)","d":3,"b":5,"e":8,"raw":["水墨画入门(2班) (人文艺术类-艺术类)","2","1-15","陈莉(教师)","周四5-8节(每周)(文C#307)(9-15周)","25"]},
  {"n":"西方音乐赏析(1班) (人文艺术类-艺术类)","t":"陈恺麟","s":"周四7-8节(每周)(待定)(1-15周)","d":3,"b":7,"e":8,"raw":["西方音乐赏析(1班) (人文艺术类-艺术类)","2","1-15","陈恺麟","周四7-8节(每周)(待定)(1-15周)","17"]},
  {"n":"西方音乐赏析(2班) (人文艺术类-艺术类)","t":"陈恺麟","s":"周四9-10节(每周)(待定)(1-15周)","d":3,"b":9,"e":10,"raw":["西方音乐赏析(2班) (人文艺术类-艺术类)","2","1-15","陈恺麟","周四9-10节(每周)(待定)(1-15周)","33"]},
  {"n":"西方音乐赏析(3班) (人文艺术类-艺术类)","t":"许鹭佳","s":"周四9-10节(每周)(待定)(1-15周)","d":3,"b":9,"e":10,"raw":["西方音乐赏析(3班) (人文艺术类-艺术类)","2","1-15","许鹭佳","周四9-10节(每周)(待定)(1-15周)","73"]},
  {"n":"西方音乐赏析(4班) (人文艺术类-艺术类)","t":"李丽莉","s":"周二7-8节(每周)(待定)(1-15周)","d":1,"b":7,"e":8,"raw":["西方音乐赏析(4班) (人文艺术类-艺术类)","2","1-15","李丽莉","周二7-8节(每周)(待定)(1-15周)","67"]},
  {"n":"小提琴入门 (人文艺术类-艺术类)","t":"赵纯","s":"周二9-10节(每周)(学活#132)(1-15周)","d":1,"b":9,"e":10,"raw":["小提琴入门 (人文艺术类-艺术类)","2","1-15","赵纯","周二9-10节(每周)(学活#132)(1-15周)","10"]},
  {"n":"硬笔书法(1班) (人文艺术类-艺术类)","t":"王占北","s":"周三3-4节(每周)(待定)(1-15周)","d":2,"b":3,"e":4,"raw":["硬笔书法(1班) (人文艺术类-艺术类)","2","1-15","王占北","周三3-4节(每周)(待定)(1-15周)","2"]},
  {"n":"硬笔书法(2班) (人文艺术类-艺术类)","t":"王占北","s":"周四7-8节(每周)(待定)(1-15周)","d":3,"b":7,"e":8,"raw":["硬笔书法(2班) (人文艺术类-艺术类)","2","1-15","王占北","周四7-8节(每周)(待定)(1-15周)","12"]},
  {"n":"硬笔书法(3班) (人文艺术类-艺术类)","t":"王占北","s":"周四9-10节(每周)(待定)(1-15周)","d":3,"b":9,"e":10,"raw":["硬笔书法(3班) (人文艺术类-艺术类)","2","1-15","王占北","周四9-10节(每周)(待定)(1-15周)","13"]},
  {"n":"中国传统乐器概论 (人文艺术类-艺术类)","t":"张婷婷","s":"周四7-8节(每周)(待定)(1-15周)","d":3,"b":7,"e":8,"raw":["中国传统乐器概论 (人文艺术类-艺术类)","2","1-15","张婷婷","周四7-8节(每周)(待定)(1-15周)","74"]},
  {"n":"中外建筑与园林艺术赏析 (人文艺术类-艺术类)","t":"孟晓鹏","s":"周二7-8节(每周)(待定)(1-15周)","d":1,"b":7,"e":8,"raw":["中外建筑与园林艺术赏析 (人文艺术类-艺术类)","2","1-15","孟晓鹏","周二7-8节(每周)(待定)(1-15周)","18"]},
  {"n":"中外美术简史(1班) (人文艺术类-艺术类)","t":"侯思雨","s":"周四9-10节(每周)(待定)(1-15周)","d":3,"b":9,"e":10,"raw":["中外美术简史(1班) (人文艺术类-艺术类)","2","1-15","侯思雨","周四9-10节(每周)(待定)(1-15周)","43"]},
  {"n":"中外美术简史(2班) (人文艺术类-艺术类)","t":"厉犇","s":"周四9-10节(每周)(待定)(1-15周)","d":3,"b":9,"e":10,"raw":["中外美术简史(2班) (人文艺术类-艺术类)","2","1-15","厉犇","周四9-10节(每周)(待定)(1-15周)","48"]},
  {"n":"道德心理学(1班) (社会科学类-社会科学类)","t":"王瑞乐","s":"周三7-8节(每周)(待定)(1-15周)","d":2,"b":7,"e":8,"raw":["道德心理学(1班) (社会科学类-社会科学类)","2","1-15","王瑞乐","周三7-8节(每周)(待定)(1-15周)","19"]},
  {"n":"道德心理学(2班) (社会科学类-社会科学类)","t":"王瑞乐","s":"周四9-10节(每周)(待定)(1-15周)","d":3,"b":9,"e":10,"raw":["道德心理学(2班) (社会科学类-社会科学类)","2","1-15","王瑞乐","周四9-10节(每周)(待定)(1-15周)","14"]},
  {"n":"改变世界的经济学家(1班) (社会科学类-社会科学类)","t":"廖伶欣","s":"周四7-8节(每周)(待定)(1-15周)","d":3,"b":7,"e":8,"raw":["改变世界的经济学家(1班) (社会科学类-社会科学类)","2","1-15","廖伶欣","周四7-8节(每周)(待定)(1-15周)","45"]},
  {"n":"改变世界的经济学家(2班) (社会科学类-社会科学类)","t":"廖伶欣","s":"周四9-10节(每周)(待定)(1-15周)","d":3,"b":9,"e":10,"raw":["改变世界的经济学家(2班) (社会科学类-社会科学类)","2","1-15","廖伶欣","周四9-10节(每周)(待定)(1-15周)","73"]},
  {"n":"国际经济学引论 (社会科学类-社会科学类)","t":"陈思慎","s":"周二7-8节(每周)(待定)(1-15周)","d":1,"b":7,"e":8,"raw":["国际经济学引论 (社会科学类-社会科学类)","2","1-15","陈思慎","周二7-8节(每周)(待定)(1-15周)","76"]},
  {"n":"婚姻家庭与继承法入门(1班) (社会科学类-社会科学类)","t":"常宝莲","s":"周四7-8节(每周)(待定)(1-15周)","d":3,"b":7,"e":8,"raw":["婚姻家庭与继承法入门(1班) (社会科学类-社会科学类)","2","1-15","常宝莲","周四7-8节(每周)(待定)(1-15周)","43"]},
  {"n":"婚姻家庭与继承法入门(2班) (社会科学类-社会科学类)","t":"常宝莲","s":"周四9-10节(每周)(待定)(1-15周)","d":3,"b":9,"e":10,"raw":["婚姻家庭与继承法入门(2班) (社会科学类-社会科学类)","2","1-15","常宝莲","周四9-10节(每周)(待定)(1-15周)","64"]},
  {"n":"经济学的世界 (社会科学类-社会科学类)","t":"廖汶钊","s":"周二9-10节(每周)(待定)(1-15周)","d":1,"b":9,"e":10,"raw":["经济学的世界 (社会科学类-社会科学类)","2","1-15","廖汶钊","周二9-10节(每周)(待定)(1-15周)","78"]},
  {"n":"全球化与国际政治经济大变局 (社会科学类-社会科学类)","t":"王全红","s":"周二7-8节(每周)(待定)(1-15周)","d":1,"b":7,"e":8,"raw":["全球化与国际政治经济大变局 (社会科学类-社会科学类)","2","1-15","王全红","周二7-8节(每周)(待定)(1-15周)","59"]},
  {"n":"人工智能经济学 (社会科学类-社会科学类)","t":"曾凡","s":"周二7-8节(每周)(待定)(1-15周)","d":1,"b":7,"e":8,"raw":["人工智能经济学 (社会科学类-社会科学类)","2","1-15","曾凡","周二7-8节(每周)(待定)(1-15周)","77"]},
  {"n":"奢侈品与时尚品牌管理(2班) (社会科学类-社会科学类)","t":"陈婷婷","s":"周二7-8节(每周)(待定)(1-15周)","d":1,"b":7,"e":8,"raw":["奢侈品与时尚品牌管理(2班) (社会科学类-社会科学类)","2","1-15","陈婷婷","周二7-8节(每周)(待定)(1-15周)","6"]},
  {"n":"社会心理学概论(2班) (社会科学类-社会科学类)","t":"郭治斌","s":"周三9-10节(每周)(待定)(1-15周)","d":2,"b":9,"e":10,"raw":["社会心理学概论(2班) (社会科学类-社会科学类)","2","1-15","郭治斌","周三9-10节(每周)(待定)(1-15周)","9"]},
  {"n":"社会心理学概论(3班) (社会科学类-社会科学类)","t":"翁誉华","s":"周三3-4节(每周)(待定)(1-15周)","d":2,"b":3,"e":4,"raw":["社会心理学概论(3班) (社会科学类-社会科学类)","2","1-15","翁誉华","周三3-4节(每周)(待定)(1-15周)","55"]},
  {"n":"社会心理学概论(4班) (社会科学类-社会科学类)","t":"翁誉华","s":"周三7-8节(每周)(待定)(1-15周)","d":2,"b":7,"e":8,"raw":["社会心理学概论(4班) (社会科学类-社会科学类)","2","1-15","翁誉华","周三7-8节(每周)(待定)(1-15周)","46"]},
  {"n":"世界法律文化巡礼 (社会科学类-社会科学类)","t":"王思杰","s":"周二9-10节(每周)(待定)(1-15周)","d":1,"b":9,"e":10,"raw":["世界法律文化巡礼 (社会科学类-社会科学类)","2","1-15","王思杰","周二9-10节(每周)(待定)(1-15周)","52"]},
  {"n":"数智时代的法律素养 (社会科学类-社会科学类)","t":"林玉芳","s":"周二9-10节(每周)(待定)(1-15周)","d":1,"b":9,"e":10,"raw":["数智时代的法律素养 (社会科学类-社会科学类)","2","1-15","林玉芳","周二9-10节(每周)(待定)(1-15周)","79"]},
  {"n":"外汇知识入门 (社会科学类-社会科学类)","t":"黄洁(会)","s":"周二9-10节(每周)(待定)(1-15周)","d":1,"b":9,"e":10,"raw":["外汇知识入门 (社会科学类-社会科学类)","2","1-15","黄洁(会)","周二9-10节(每周)(待定)(1-15周)","73"]},
  {"n":"文化心理学 (社会科学类-社会科学类)","t":"石舒雅","s":"周三9-10节(每周)(待定)(1-15周)","d":2,"b":9,"e":10,"raw":["文化心理学 (社会科学类-社会科学类)","2","1-15","石舒雅","周三9-10节(每周)(待定)(1-15周)","24"]},
  {"n":"现代设计思维 (社会科学类-社会科学类)","t":"吴国荣","s":"周二9-10节(每周)(待定)(1-15周)","d":1,"b":9,"e":10,"raw":["现代设计思维 (社会科学类-社会科学类)","2","1-15","吴国荣","周二9-10节(每周)(待定)(1-15周)","57"]},
  {"n":"新时代经济发展的密钥与未来 (社会科学类-社会科学类)","t":"郭宏","s":"周二9-10节(每周)(待定)(1-15周)","d":1,"b":9,"e":10,"raw":["新时代经济发展的密钥与未来 (社会科学类-社会科学类)","2","1-15","郭宏","周二9-10节(每周)(待定)(1-15周)","80"]},
  {"n":"新时代幸福观(1班) (社会科学类-社会科学类)","t":"颜明健","s":"周二7-8节(每周)(经管#301)(1-15周)","d":1,"b":7,"e":8,"raw":["新时代幸福观(1班) (社会科学类-社会科学类)","2","1-15","颜明健","周二7-8节(每周)(经管#301)(1-15周)","6"]},
  {"n":"新时代幸福观(2班) (社会科学类-社会科学类)","t":"颜明健","s":"周四7-8节(每周)(经管#301)(1-15周)","d":3,"b":7,"e":8,"raw":["新时代幸福观(2班) (社会科学类-社会科学类)","2","1-15","颜明健","周四7-8节(每周)(经管#301)(1-15周)","40"]},
  {"n":"影视中的证券知识(1班) (社会科学类-社会科学类)","t":"陈晓松","s":"周四7-8节(每周)(待定)(1-15周)","d":3,"b":7,"e":8,"raw":["影视中的证券知识(1班) (社会科学类-社会科学类)","2","1-15","陈晓松","周四7-8节(每周)(待定)(1-15周)","52"]},
  {"n":"政治哲学与现代社会 (社会科学类-社会科学类)","t":"占强","s":"周四7-8节(每周)(待定)(1-15周)","d":3,"b":7,"e":8,"raw":["政治哲学与现代社会 (社会科学类-社会科学类)","2","1-15","占强","周四7-8节(每周)(待定)(1-15周)","65"]},
  {"n":"中华民族共同体概论(1班) (社会科学类-社会科学类)","t":"杨维周","s":"周二7-8节(每周)(待定)(1-15周)","d":1,"b":7,"e":8,"raw":["中华民族共同体概论(1班) (社会科学类-社会科学类)","2","1-15","杨维周","周二7-8节(每周)(待定)(1-15周)","78"]},
  {"n":"中华民族共同体概论(2班) (社会科学类-社会科学类)","t":"杨维周","s":"周四7-8节(每周)(待定)(1-15周)","d":3,"b":7,"e":8,"raw":["中华民族共同体概论(2班) (社会科学类-社会科学类)","2","1-15","杨维周","周四7-8节(每周)(待定)(1-15周)","77"]},
  {"n":"中外教育简史(1班) (社会科学类-社会科学类)","t":"周胜男","s":"周二7-8节(每周)(待定)(1-15周)","d":1,"b":7,"e":8,"raw":["中外教育简史(1班) (社会科学类-社会科学类)","2","1-15","周胜男","周二7-8节(每周)(待定)(1-15周)","38"]},
  {"n":"中外教育简史(2班) (社会科学类-社会科学类)","t":"周胜男","s":"周二9-10节(每周)(待定)(1-15周)","d":1,"b":9,"e":10,"raw":["中外教育简史(2班) (社会科学类-社会科学类)","2","1-15","周胜男","周二9-10节(每周)(待定)(1-15周)","62"]},
  {"n":"走进宪法 (社会科学类-社会科学类)","t":"陈雪琴","s":"周二7-8节(每周)(待定)(1-15周)","d":1,"b":7,"e":8,"raw":["走进宪法 (社会科学类-社会科学类)","2","1-15","陈雪琴","周二7-8节(每周)(待定)(1-15周)","77"]},
  {"n":"化学与人类文明(2班) (自然科学类)","t":"吴江毅","s":"周四9-10节(每周)(待定)(1-15周)","d":3,"b":9,"e":10,"raw":["化学与人类文明(2班) (自然科学类)","2","1-15","吴江毅","周四9-10节(每周)(待定)(1-15周)","31"]},
  {"n":"计算思维与计算机科学 (自然科学类)","t":"李瑞珠","s":"周二9-10节(每周)(待定)(1-15周)","d":1,"b":9,"e":10,"raw":["计算思维与计算机科学 (自然科学类)","2","1-15","李瑞珠","周二9-10节(每周)(待定)(1-15周)","50"]},
  {"n":"计算与AI思维:走进数智科学 (自然科学类)","t":"王尔绂","s":"周四7-8节(每周)(待定)(1-15周)","d":3,"b":7,"e":8,"raw":["计算与AI思维:走进数智科学 (自然科学类)","2","1-15","王尔绂","周四7-8节(每周)(待定)(1-15周)","64"]},
  {"n":"建筑消防安全(2班) (自然科学类)","t":"薛艳霞","s":"周四9-10节(每周)(待定)(1-15周)","d":3,"b":9,"e":10,"raw":["建筑消防安全(2班) (自然科学类)","2","1-15","薛艳霞","周四9-10节(每周)(待定)(1-15周)","11"]},
  {"n":"力学世界 (自然科学类)","t":"贾檀","s":"周四7-8节(每周)(待定)(1-15周)","d":3,"b":7,"e":8,"raw":["力学世界 (自然科学类)","2","1-15","贾檀","周四7-8节(每周)(待定)(1-15周)","33"]},
  {"n":"区块链应用技术基础 (自然科学类)","t":"詹志超","s":"周四7-8节(每周)(待定)(1-15周)","d":3,"b":7,"e":8,"raw":["区块链应用技术基础 (自然科学类)","2","1-15","詹志超","周四7-8节(每周)(待定)(1-15周)","60"]},
  {"n":"神奇的材料世界 (自然科学类)","t":"吴悦","s":"周四9-10节(每周)(待定)(1-15周)","d":3,"b":9,"e":10,"raw":["神奇的材料世界 (自然科学类)","2","1-15","吴悦","周四9-10节(每周)(待定)(1-15周)","4"]},
  {"n":"生命科学史(1班) (自然科学类)","t":"乔红梅","s":"周二9-10节(每周)(待定)(1-15周)","d":1,"b":9,"e":10,"raw":["生命科学史(1班) (自然科学类)","2","1-15","乔红梅","周二9-10节(每周)(待定)(1-15周)","26"]},
  {"n":"生命科学史(2班) (自然科学类)","t":"乔红梅","s":"周二7-8节(每周)(待定)(1-15周)","d":1,"b":7,"e":8,"raw":["生命科学史(2班) (自然科学类)","2","1-15","乔红梅","周二7-8节(每周)(待定)(1-15周)","3"]},
  {"n":"数学史 (自然科学类)","t":"陈洪科","s":"周四7-8节(每周)(待定)(1-15周)","d":3,"b":7,"e":8,"raw":["数学史 (自然科学类)","2","1-15","陈洪科","周四7-8节(每周)(待定)(1-15周)","44"]},
  {"n":"物理与艺术 (自然科学类)","t":"蔡兆晖","s":"周四7-8节(每周)(待定)(1-15周)","d":3,"b":7,"e":8,"raw":["物理与艺术 (自然科学类)","2","1-15","蔡兆晖","周四7-8节(每周)(待定)(1-15周)","45"]},
  {"n":"新能源技术与应用 (自然科学类)","t":"周书伟","s":"周四7-8节(每周)(待定)(1-15周)","d":3,"b":7,"e":8,"raw":["新能源技术与应用 (自然科学类)","2","1-15","周书伟","周四7-8节(每周)(待定)(1-15周)","32"]}
        ]
    },
        // "创意与设计": {
    //     "notice": "🎨 <b>创意提醒：</b>《平面设计》需要自带电脑上课，教室配置了专业手绘板。",
    //     "courses": [
    //         {"n":"平面设计基础(设计)","t":"陈老师","s":"周二3-6节","d":1,"b":3,"e":6},
    //         {"n":"短视频创意(影像)","t":"刘老师","s":"周四7-8节","d":3,"b":7,"e":8}
    //     ]
    // }
};


const DAYS = ['周一', '周二', '周三', '周四', '周五'];
// 定义时段对应的节次范围: 0=上午(1-4), 1=下午(5-8), 2=晚上(9-12)
const PERIODS = [
    { name: '上午', range: [1, 4] },
    { name: '下午', range: [5, 8] },
    { name: '晚上', range: [9, 12] }
];

let currentPool = [];    
let currentSubTag = '全部'; 
let currentKeyword = '';

// 核心数据结构：排除矩阵 state[dayIndex][periodIndex] = boolean
// 例如 excludedMatrix[0][0] = true 代表排除周一上午
let excludedMatrix = Array(5).fill(null).map(() => [false, false, false]);

function init() {
    renderMatrixControl();
    renderGrid();
    
    const menu = document.getElementById('menu');
    Object.keys(DATA_STORE).forEach((key, index) => {
        const item = document.createElement('div');
        item.className = 'db-item' + (index===0?' active':'');
        item.innerText = key;
        item.onclick = () => {
            document.querySelectorAll('.db-item').forEach(i => i.classList.remove('active'));
            item.classList.add('active');
            switchGroup(key);
        };
        menu.appendChild(item);
        if(index === 0) switchGroup(key);
    });

    if(window.innerWidth <= 1024) {
        document.getElementById('mobile-hint').style.display = 'inline';
    }
}

// 1. 渲染排除矩阵控制面板
function renderMatrixControl() {
    const container = document.getElementById('matrixContainer');
    let html = '<div class="mx-cell" style="border:none; background:none;"></div>'; // 左上角空白
    
    // 表头：周一到周五 (点击可整列排除)
    DAYS.forEach((d, dayIdx) => {
        const isColFull = excludedMatrix[dayIdx].every(v => v === true);
        const activeClass = isColFull ? 'excluded' : '';
        html += `<div class="mx-cell mx-head-col ${activeClass}" onclick="toggleColumn(${dayIdx})">${d}</div>`;
    });

    // 表内容：三行 (上午/下午/晚上)
    PERIODS.forEach((p, pIdx) => {
        // 行头 (点击可整行排除)
        // 检查该行是否全被排除
        let isRowFull = true;
        for(let d=0; d<5; d++) { if(!excludedMatrix[d][pIdx]) isRowFull = false; }
        
        html += `<div class="mx-cell mx-head-row ${isRowFull?'excluded':''}" onclick="toggleRow(${pIdx})">${p.name}</div>`;
        
        // 具体的格子
        for(let d=0; d<5; d++) {
            const isExcluded = excludedMatrix[d][pIdx];
            // 显示简写，如 "一上", "二下" 或者 简单的方块符号
            // 为了美观，未排除显示空，排除显示 "屏蔽" 或 图标
            const content = isExcluded ? '🚫' : '';
            html += `<div class="mx-cell ${isExcluded ? 'excluded' : ''}" onclick="toggleMatrixCell(${d}, ${pIdx})">${content}</div>`;
        }
    });

    container.innerHTML = html;
}

// 切换单个格子
function toggleMatrixCell(d, pIdx) {
    excludedMatrix[d][pIdx] = !excludedMatrix[d][pIdx];
    renderMatrixControl();
    handleSearch();
}

// 切换整列 (周几)
function toggleColumn(d) {
    // 如果当前全选，则全反选；否则全选
    const allSelected = excludedMatrix[d].every(v => v === true);
    excludedMatrix[d] = excludedMatrix[d].map(() => !allSelected);
    renderMatrixControl();
    handleSearch();
}

// 切换整行 (上午/下午/晚上)
function toggleRow(pIdx) {
    let allSelected = true;
    for(let d=0; d<5; d++) { if(!excludedMatrix[d][pIdx]) allSelected = false; }
    
    for(let d=0; d<5; d++) {
        excludedMatrix[d][pIdx] = !allSelected;
    }
    renderMatrixControl();
    handleSearch();
}

function resetExclusion() {
    excludedMatrix = Array(5).fill(null).map(() => [false, false, false]);
    renderMatrixControl();
    handleSearch();
}

// 判断某个具体的课程大节 (1-2, 3-4...) 是否被排除
// p = 开始节次 (1, 3, 5...)
function isSlotExcluded(dayIdx, p) {
    let pIdx = -1;
    if (p <= 4) pIdx = 0;      // 上午
    else if (p <= 8) pIdx = 1; // 下午
    else pIdx = 2;             // 晚上
    
    return excludedMatrix[dayIdx][pIdx];
}

// 渲染主网格
function renderGrid() {
    const grid = document.getElementById('grid');
    grid.innerHTML = '<div class="cell head"></div>' + DAYS.map(d => `<div class="cell head">${d}</div>`).join('');
    
    for (let p = 1; p <= 11; p += 2) {
        grid.innerHTML += `<div class="cell head">${p}-${p+1}</div>`;
        for (let d = 0; d < 5; d++) {
            grid.innerHTML += `<div class="cell" id="cell-${d}-${p}" onclick="showSlotDetail(${d},${p})"></div>`;
        }
    }
}

function switchGroup(groupName) {
    const group = DATA_STORE[groupName];
    currentPool = group.courses || [];
    currentSubTag = '全部';
    document.getElementById('banner').innerHTML = group.notice || "暂无当前课程组公告信息。";

    const subTags = new Set(['全部']);
    currentPool.forEach(c => {
        if (c.subCategory) subTags.add(c.subCategory);
        else subTags.add("其他");
    });

    const container = document.getElementById('filterChips');
    container.innerHTML = '';
    Array.from(subTags).forEach(tag => {
        const chip = document.createElement('div');
        chip.className = `tag-chip ${tag === '全部' ? 'active' : ''}`;
        chip.innerText = tag;
        chip.onclick = () => {
            document.querySelectorAll('.tag-chip').forEach(tc => tc.classList.remove('active'));
            chip.classList.add('active');
            currentSubTag = tag;
            handleSearch();
        };
        container.appendChild(chip);
    });

    document.getElementById('locateSearch').value = '';
    handleSearch();
}

function getHeatColor(count, isSearch) {
    if (count === 0) return '#f8fafc';
    if (isSearch) return '#fff7ed'; 
    const step = Math.min(count, 10); 
    const lightness = 95 - (step * 6); 
    return `hsl(217, 91%, ${lightness}%)`;
}

function handleSearch() {
    currentKeyword = document.getElementById('locateSearch').value.trim().toLowerCase();
    const inputEl = document.getElementById('locateSearch');
    
    // 1. 筛选课程 (关键词 + 标签 + 矩阵排除逻辑)
    const filteredList = currentPool.filter(c => {
        // 核心排除检查
        // 判断课程开始时间落在哪个时段
        let pIdx = -1;
        if (c.b <= 4) pIdx = 0;
        else if (c.b <= 8) pIdx = 1;
        else pIdx = 2;

        // 如果该天的该时段被exclude，则过滤掉
        if (excludedMatrix[c.d][pIdx]) return false;

        const matchTag = currentSubTag === '全部' || c.subCategory === currentSubTag;
        const matchKey = !currentKeyword || c.n.toLowerCase().includes(currentKeyword) || (c.t && c.t.toLowerCase().includes(currentKeyword));
        return matchTag && matchKey;
    });

    // 2. 重置样式
    document.querySelectorAll('.cell:not(.head)').forEach(el => {
        el.className = 'cell';
        el.style.backgroundColor = '';
        el.style.color = '';
        el.style.backgroundImage = '';
        el.innerHTML = '';
        el.style.pointerEvents = 'auto';
        el.style.opacity = '1';
    });

    // 3. 应用排除样式到格子 (灰色斜纹)
    for (let p = 1; p <= 11; p += 2) {
        for (let d = 0; d < 5; d++) {
            if (isSlotExcluded(d, p)) {
                const el = document.getElementById(`cell-${d}-${p}`);
                if(el) el.classList.add('excluded-slot');
            }
        }
    }

    // 4. 填充热力数据
    const counts = {};
    filteredList.forEach(c => {
        const bigSlot = c.b % 2 === 0 ? c.b - 1 : c.b; 
        const key = `${c.d}-${bigSlot}`;
        counts[key] = (counts[key] || 0) + 1;
    });

    Object.keys(counts).forEach(k => {
        const el = document.getElementById(`cell-${k}`);
        // 仅当未被排除时显示
        if(el && !el.classList.contains('excluded-slot')) {
            const n = counts[k];
            el.innerHTML = `<span style="font-size:16px; font-weight:800">${n}</span><span style="font-size:9px; opacity:0.8">门</span>`;
            
            if (currentKeyword) {
                el.classList.add('search-match');
                inputEl.classList.add('searching');
            } else {
                el.style.backgroundColor = getHeatColor(n, false);
                el.style.color = n > 5 ? '#fff' : '#1e40af';
                inputEl.classList.remove('searching');
            }
        }
    });
    
    renderList(currentKeyword ? filteredList : null);
}

function showSlotDetail(d, p) {
    if (isSlotExcluded(d, p)) return;

    document.querySelectorAll('.cell').forEach(el => el.classList.remove('active-slot'));
    const target = document.getElementById(`cell-${d}-${p}`);
    if(target) target.classList.add('active-slot');

    document.getElementById('slotInfo').innerText = `${DAYS[d]} 第${p}-${p+1}节 选中详情`;
    
    const slotList = currentPool.filter(c => {
        // 同样的排除逻辑检查，确保列表与网格一致
        let pIdx = -1;
        if (c.b <= 4) pIdx = 0;
        else if (c.b <= 8) pIdx = 1;
        else pIdx = 2;
        if (excludedMatrix[c.d][pIdx]) return false;

        const matchTag = currentSubTag === '全部' || c.subCategory === currentSubTag;
        const matchKey = !currentKeyword || c.n.toLowerCase().includes(currentKeyword) || (c.t && c.t.toLowerCase().includes(currentKeyword));
        const hasOverlap = (c.b <= p+1 && c.e >= p);
        return matchTag && matchKey && c.d === d && hasOverlap;
    });
    
    renderList(slotList, true);

    if (window.innerWidth <= 1024) {
        setTimeout(() => {
            document.querySelector('.side-panel').scrollIntoView({ behavior: 'smooth' });
        }, 100);
    }
}

function renderList(list, isManual = false) {
    const container = document.getElementById('courseList');
    const titleEl = document.getElementById('panelTitle');
    
    if (!list && !isManual) {
        titleEl.innerText = "💡 课程详情";
        container.innerHTML = '<div style="color:#94a3b8; text-align:center; margin-top:50px; font-size:12px;">点击格子查看时段课程</div>';
        return;
    }

    titleEl.innerText = isManual ? "📍 选中节次课程" : `🔍 筛选结果 (${list.length})`;
    container.innerHTML = '';

    if(!list || list.length === 0) {
        container.innerHTML = '<div style="color:#f43f5e; text-align:center; margin-top:50px; font-size:12px;">该时段暂无匹配课程（或已被排除）</div>';
        return;
    }

    list.forEach(c => {
        const card = document.createElement('div');
        card.className = 'course-card';
        card.innerHTML = `
            <div class="card-head">${c.n}</div>
            <div class="card-body">
                <div>👤 教师：${c.t || '未知'}</div>
                <div>⏰ 时间：${c.s || '见系统'}</div>
                <div style="margin-top:4px; font-size:10px; color:#94a3b8; border:1px solid #e2e8f0; display:inline-block; padding:0 4px; border-radius:4px;">${c.subCategory || '通识'}</div>
            </div>
        `;
        container.appendChild(card);
    });
}

init();
</script>
</body>
</html>
